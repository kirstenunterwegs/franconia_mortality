---
title: "Quantifying the propensity of forest reorganization"
author: "Mária Potterf"
date:  "`r Sys.Date()`"
output: 
  bookdown::html_document2:
    toc: true
knit: (function(inputFile, encoding) { rmarkdown::render(inputFile, encoding = encoding, output_file = file.path(dirname(inputFile),glue::glue('forest_reorg_{Sys.Date()}')))})


---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, tidy = TRUE, tidy.opts = list(comment = FALSE), message = F, warning = F)
knitr::opts_chunk$set(fig.width=6, fig.height=2.5) 



```


```{css, echo=FALSE}
p.caption {
  font-size: 0.8em;
}
```

# Background and implementation:

Identify the aspects of the forest reorganization:

* in forest composition: **Reassembly**

    + **RA1**:  Novel species: Presence: Are novel species present? What is their *importance value* (IV)?
    + **RA2**: Novel species: Competition: CWM of shade tolerance for novel species. Is it lower then reference? 
    + **RA3**: Competition: Dominance: Is the same species dominant before and after the disturbance? 
    + **RA4**: Competition: Tree size: Is the most frequent tallest tree same under Ref and disturbed conditions?


* in forest structure: **Restructuring**

    + **RS1**: Stem density: Are pre-disturbance stem densities possible based on the post-disturbance stem density? (> then 2 times higher?)
    + **RS2**: Gap fraction : Share of plots per site that have no trees >10cm dbh?
    + **RS3**: Infilling: Is there enough bare soils for next tree cohort to establish?
    + **RS4**: Diameter distribution: Is the diameter distribution homogeneous or heterogeneous? Based on variance of DBH distribution in Ref, and number of living trees in Dist site


## Composite indicators:

### For reassembly

All reassembly indicators are given equal weights in the aggregation towards a composite indicator of reassembly (RA):

RA = (RA1+RA2+RA3+RA4)/4


### For restructuring

Early indications of restructuring (RS) are derived from the analyses of stem density (RS1), gap fraction (RS2) and diameter distribution (RS4). If there is considerable ability for infilling (RS3), the impact of reduced stem density (RS1) or increased gaps (RS2) are compensated:

 - If RS1=1 and RS3=1 then RS1=0.5
 - If RS2=1 and RS3=1 then RS2=0.5

RS = (RS1+RS2+RS4)/3

**Final classification of triplets**:

Restructuring, reassembly, replacement, resilience:

 - If RS≤0.5 and RA≤0.5 → Resilience
 - If RS>0.5 and RA≤0.5 → Restructuring
 - If RS≤0.5 and RA>0.5 → Reassembly
 - If RS>0.5 and RA>0.5 → Replacement


![Fig. Response pathways of Forest reorganization (Seidl & Turner 2022)](images/response_pathways.png){width=75%}


# Describe study sites: 

The number of samples triplets by dominant tree species. Each triplet has 3 management categories: 

- Ref  - reference, undisturbed sites
- Dist - disturbed sites by drought, uncleared
- Cleared - will be evaluated in next round


```{r read-libs, eval = TRUE, echo=FALSE, include = FALSE, warning = FALSE, error = FALSE }
# rm(list=ls())

# Input data -------------------------------------------------------------------
#getwd()
load(file = paste(getwd(), "dataToPlot.Rdata", sep = '/'))
load(file = paste(getwd(), "dat_restr.Rdata", sep = '/'))


#### Source paths and functions  -----------------------------------------------

source('myPaths.R')


#### Read libraries  -----------------------------------------------------------
library(knitr)
library(readxl)
library(dplyr)
library(data.table)
library(tidyr)
library(ggplot2)
library(stringr)  # use regex expressions
#library(gridExtra)
library(ggpubr)

##### Stats
#library(MuMIn)
#library(vegan)
#library(mgcv)
#library(gratia) # visualization of mcv


## Colors
cols = c('#0072B2', # 
         '#E69F00', # 
         '#F0E442', # 
         '#000000') # black: spruce


```


```{r triplet-count, echo=FALSE}
#print(getwd())
out_summary <- dat %>% 
 group_by(dom_sp) %>%
 distinct(trip_n) %>%
 tally() %>%
 rename(species=dom_sp,
        triplets_count = n)

```


```{r sites-count, echo=FALSE}
n_sites <- 
  dat %>% 
  group_by(trip_n, dom_sp, manag, sub_n) %>% 
  distinct() %>% 
  nrow() 

```

**Sites overview:** 

Triplets count:  **`r length(unique(dat$trip_n))`**

Total count of plots (4m2) per triplet&category : **`r n_sites`** plots



```{r print-summary, echo=F}
# print nice table in knitr
out_summary %>% knitr::kable("markdown")



```

## Species importance value

Calculate **species importance value**
from: https://kimmerer.com/trees/importance-value/

**Importance Value** is a measure of how dominant a species is in a given forest area. It is a standard tool used by foresters to inventory a forest.  Foresters generally do not inventory a forest by counting all the trees, but by locating points in the forest and sampling a specified area around those points.  Three kinds of data are collected:

 - *Relative frequency*, the percent of inventory points occupied by species A as a percent of the occurence of all species.  If species A is found in 5 out of 8 sample points, its relative frequency is 62.5%
 - *Relative density*, the number of individuals per area as a percent of the number of individuals of all species.
 - *Relative basal area*.  the total basal area of Species A as a percent of the total basal area of all species.  Basal area is the sum of the cross sectional area of all the trees of species A, measured at 4.5 ft. above ground. The forester actually measures diameter and then converts that number to basal area.
 
Each of these values is expressed as a percent, and ranges from 0 to 100.

The **Importance Value** is the sum of these three measures, and can range from 0 to 300.

 **Importance value** calculated here considers the extent of the 4m2 plot. 
 
 
**Collected data overview**: 
 
 
Plot (4m2):  

 - seedlings:
    +  regeneration < 1.3 m: BA = 0, 
    + regeneration 1.3m-2 m, estimated DBH = 0.8 cm, BA accordingly
 - advanced regeneration: 
    + DBH & height measured for each tree
 - mature trees:
    + DBH measured for each tree
 
 
Surroundings (<15m from plot center):

 - nearest advanced regeneration: species
 - nearest mature tree: species, DBH
 




# Quantify forest reorganization


## RA1: Novel species: Presence

Are novel species (i.e., species that are not present under reference conditions) present after disturbance?

 - Ref: Calculate the relative importance value (rIV) of all species in the reference stands from relative stem density, relative basal area, and relative frequency of all tree species across all sample plots per site. rIV is IV [0-300] scaled to a [0-100] scale, i.e. divided by 3. 
 - Dist: Calculate the rIV of all species in the disturbed stands from relative stem density, relative basal area, and relative frequency of all tree species across all sample plots per site. If basal area is zero , omit this component of IV and calculate it only based on relative density and relative frequency. In this case, IV is [0-300], and rIV = IV/3.
 - I: Sum the rIV of all species in Dist that are not present in Ref
 - If   I>50 then RA1 = 1 else RA=0   

 - **NA -> 0**: if the novel species are not important: no change  

Data:

 - plot level: seedlings, saplings, mature trees   
 - surroundings: nearest Mature, advanced regeneration


```{r plot-RA1, echo = F, fig.height=3, fig.width=3, fig.cap="Boxplots of the sums of species importance values per reference and disturbed sites. Lines represent sites located in one triplet."}

p_RA1  

```

## RA2: Novel species: Competition 

Are the novel tree species  present after disturbance likely to outcompete the tree species under reference conditions or hinder their establishment?

 - Ref: Community-weighted mean   shade tolerance of the species present under reference conditions (across all plots per site)
 - Dist: Community-weighted mean shade tolerance of the species present after disturbance that are not present under reference conditions (across all plots per site)
 - If Dist > Ref  then RA2=1 else RA2=0
 
 - **NA -> 0**: if the novel species are not present: no change

Data:

 - plot level: seedlings, saplings, mature trees   
 - surroundings: nearest Mature, advanced regeneration  

```{r plot-RA2, echo = F, fig.height=3, fig.width=3, fig.cap="Boxplots of the shading tolerance (community weighted means) for reference and disturbed sites. Lines represent sites located in one triplet."}

p_RA2

```


## RA3: Competition: Dominance

Is the species dominating after disturbance the same that dominates under reference conditions?

 - Ref: Species with highest rIV under reference conditions (across all plots per site)
 - Dist: Species with highest rIV post disturbance (across all plots per site)
 - If Ref=Dist then RA3=0 else RA3=1
 
 - **if NA**-> 1: if the species is missing, it differs from the reference stand -> change

Data:

 - plot level: seedlings, saplings, mature trees   
 - surroundings: nearest Mature, advanced regeneration    
 
```{r plot-RA3, echo = F, fig.height=3, fig.width=4, fig.cap="Dominant tree species composition for reference and disturbed sites. "}

p_RA3


```


## RA4: Competition - Tree size: height

Is the species winning the local competition in the regeneration the same that dominates under reference conditions? Based on height classes.

 - Ref: Determine the species that has most often the tallest trees across plots
 - Dist: Determine the species that is most often the largest tree across plots
 - If Ref=Dist then RA4=0 else RA4=1
 
 - **if NA** -> 1: if the species is missing, it differs from the reference stand -> change

Data:

 - only plot level: seedlings, saplings
 
```{r plot-RA4, echo = F, fig.height=3, fig.width=4, fig.cap="Dominant tree species height for reference and disturbed sites. "}

p_RA4

```



# Restructuring

## RS1: Stem density

Are pre-disturbance stem densities possible based on the post-disturbance stem density?
Indicator: Regeneration sStem density in regeneration disturbed site divided by stem density in reference

 - Ref: Stem density under reference conditions (across all plots per site)
 - Dist: Stem density after disturbance (across all plots per site)
 - I: Dist / Ref
 - If I>2  then RS1=0 else RS1=1
 
  - **if NA** -> 1: if the regeneration is missing -> change
  
Data:

 - plot level: seedlings, saplings, mature trees   
 - surroundings: nearest Mature, advanced regeneration    



```{r plot-RS1, echo = F, fig.height=3, fig.width=3, fig.cap="Boxplots of the stem density for forest regeneration for reference and disturbed sites. Lines represent sites located in one triplet."}

p_RS1

```


## RS2: Gap fraction

Is the spatial structure in terms of gaps similar pre- and post-disturbance?

 - Ref: Share of plots per site that have no trees >10cm dbh per site under reference conditions
 - Dist: Share of plots per site that have no trees > 10cm dbh per site after disturbance
 - I: Dist / Ref 
 - If **I>1.1**  then RS2=1 else RS2=0  !!! change here from the Protocol!! (was 2 instead of 1.1)

  - **no NA**: if the trees are missing => gap  = 100%
  
  Data:

 - plot level: seedlings, saplings, mature trees   
 - surroundings: nearest Mature, advanced regeneration    

  
```{r plot-RS2, echo = F, fig.height=3, fig.width=3, fig.cap="Boxplots of the gap share [%] for reference and disturbed sites. Lines represent sites located in one triplet."}

p_RS2

```


## RS3: Infilling 

Is infilling likely possible? Evaluate the share of the bare soil (here category soil/foliage)

 - Dist: Share of 4m² plot that is not covered by vegetation (across all plots per site)
 - If Dist>0.5 then RS3=1 else RS3=0
 
 - **no NA**

Data:

 - plot: ground cover [%] 

```{r plot-RS3, echo = F, fig.height=3, fig.width=3, fig.cap="Boxplots of the bare soils share for reference and disturbed sites. Lines represent sites located in one triplet."}

p_RS3


```




## RS4: Diameter distribution

Is the diameter distribution homogeneous or heterogeneous?

 –	Ref : (dbhmax – dbhmin)/dbhmean in reference stands
 
 –	Dist: Number of live legacy trees >10cm dbh [n per ha]

 - If Ref>1 and Dist>10  then RS4=0
 - If Ref≤1 and Dist≤10  then RS4=0
 - If Ref>1 and Dist≤10  then RS4=1
 - If Ref≤1 and Dist >10 then RS4=1

 - Interpretation: is there are more mature trees (Dist>10/ha), the heterogeneity is higher?
 
 - **No NA**
 
 Data:

 - plot level: seedlings, saplings, mature trees   
 - surroundings: nearest Mature, advanced regeneration    
 
```{r plot-RS4, echo = F, fig.height=3, fig.width=4, fig.cap="Left: Normalized diameter size distribution ((dbhmax – dbhmin)/dbhmean ) for reference site. Right: Number of trees > 10 cm DBH per disturbed site. "}

p_RS4_agg

```


```{r plot-density, echo = F, fig.height=5, fig.width=5, fig.cap="DBH density distribution for advanced and mature trees per management categories. Note different scales. Vertical line represents mean per category." }

p_dbh_dist
```

DBH distribution summary


```{r print-summary-dbh, echo=F}
# print nice table in knitr
dummy %>% knitr::kable("markdown", digits = 1, caption = 'DBH distribution summary and normalized values')

```

# Final categorization

Classify the values:

 - If RS≤0.5 and RA≤0.5 → *Resilience*
 - If RS>0.5 and RA≤0.5 → *Restructuring*
 - If RS≤0.5 and RA>0.5 → *Reassembly*
 - If RS>0.5 and RA>0.5 → *Replacement*
 

The share of the sites that reorganize towards individual categories by dominant tree species: (the coloring scheme needs some grouping by species and shades: can be done in next step).



```{r plot-Reorganization-tree, echo = F, fig.height=5, fig.width=5.7, fig.cap='Tree plot of the shared forest reorganization categories by individual dominant tree species. The % relates to overall number of triplets (40); disregarding the different shares of tree species.'}

tree_plot

```
The share of the triplets by forest reorganization classes by dominant tree species.  


```{r plot-reorg-stacked, echo = F, fig.height=3, fig.width=5, fig.cap = 'Stacked proportion barplot of the Forest reorganization categories by dominant species.'}

p_stacked_reorg

```



